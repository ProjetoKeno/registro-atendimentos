<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Consulta de Atendimentos</title>
  <link rel="icon" type="image/x-icon" href="/img/favicon.ico" />
  <style>
    :root {
      --bg: #f8f9fa;
      --text: #343a40;
      --primary: #4CAF50;
      --primary-hover: #45a049;
      --card: #fff;
      --border: #ddd;
      --danger: #e74c3c;
      --danger-hover: #c0392b;
    }

    [data-theme="dark"] {
      --bg: #1e1e1e;
      --text: #f1f1f1;
      --card: #2c2c2c;
      --border: #444;
    }

    body {
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      padding: 20px;
      transition: background 0.3s, color 0.3s;
    }

    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: var(--primary);
    }

    .theme-toggle {
      position: fixed;
      top: 15px;
      right: 15px;
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 50px;
      font-size: 0.9rem;
      cursor: pointer;
      z-index: 999;
    }

    .dashboard {
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .card {
      background: var(--card);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      min-width: 200px;
      text-align: center;
    }

    .card h3 {
      margin: 0;
      font-size: 1rem;
      color: var(--primary);
    }

    .card span {
      font-size: 2rem;
      font-weight: bold;
    }

    .filtros {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 20px;
    }

    .filtros label {
      font-weight: bold;
    }

    .filtros select, .filtros input, .filtros button {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid var(--border);
    }

    .filtros button {
      background: var(--primary);
      color: white;
      border: none;
      cursor: pointer;
    }

    .filtros button:hover {
      background: var(--primary-hover);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--card);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }

    th, td {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }

    th {
      background: var(--primary);
      color: #fff;
    }

    tr:hover {
      background-color: #f1f1f1;
    }

    .btn-delete {
      background: var(--danger);
      color: white;
      padding: 6px 10px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .btn-delete:hover {
      background: var(--danger-hover);
    }

    .btn-voltar {
      display: block;
      width: fit-content;
      margin: 30px auto 0;
      padding: 10px 20px;
      background: var(--primary);
      color: white;
      border-radius: 6px;
      text-decoration: none;
    }

    .btn-voltar:hover {
      background: var(--primary-hover);
    }
  </style>
<!-- ... in√≠cio do <head> permanece igual ... -->
  </style>
</head>
<body>
  <button class="theme-toggle" onclick="toggleTheme()">üåô</button>

  <a href="/homepage" class="btn-voltar" style="margin: 15px 0 20px 0;">‚¨Ö Voltar para Homepage</a>

  <h2>Consulta de Atendimentos</h2>

  <div class="dashboard">
    <div class="card">
      <h3>Total no M√™s</h3>
      <span id="totalMes">0</span>
    </div>
    <div class="card">
      <h3>Instala√ß√µes</h3>
      <span id="totalInstalacoes">0</span>
    </div>
    <div class="card">
      <h3>Reinstala√ß√µes</h3>
      <span id="totalReinstalacoes">0</span>
    </div>
  </div>

  <div class="filtros">
    <label for="filtroMes">M√™s:</label>
    <input type="month" id="filtroMes" />

    <label for="filtroAgente">Agente:</label>
    <select id="filtroAgente"><option value="">Todos</option></select>

    <label for="filtroProcesso">Processo:</label>
    <select id="filtroProcesso"><option value="">Todos</option></select>

    <button onclick="buscarAtendimentos()">üîç Buscar</button>
  </div>

  <div style="text-align: right; margin-bottom: 15px;">
    <a href="/views/cadastro.html" style="padding: 8px 16px; background-color: var(--primary); color: white; border-radius: 6px; text-decoration: none;">
      ‚ûï Novo Atendimento
    </a>
  </div>

  <table>
    <thead>
      <tr>
        <th>Data</th>
        <th>Cliente</th>
        <th>Agente</th>
        <th>Processo</th>
        <th>Ticket</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="tabelaAtendimentos">
      <tr><td colspan="6" style="text-align:center;">Carregando...</td></tr>
    </tbody>
  </table>

  <script>
    async function buscarAtendimentos() {
      const mes = document.getElementById('filtroMes').value || new Date().toISOString().slice(0, 7);
      const [ano, mesNum] = mes.split('-');
      const agente = document.getElementById('filtroAgente').value;
      const processo = document.getElementById('filtroProcesso').value;

      let url = `/api/atendimentos?mes=${mesNum}&ano=${ano}`;
      if (agente) url += `&agente_id=${agente}`;
      if (processo) url += `&processos=${processo}`;

      try {
        const res = await fetch(url);
        const dados = await res.json();
        const tbody = document.getElementById('tabelaAtendimentos');
        tbody.innerHTML = dados.length
          ? dados.map(at => `
            <tr>
              <td>${new Date(at.data_solicitacao).toLocaleDateString()}</td>
              <td>${at.cliente}</td>
              <td>${at.agente || 'N/A'}</td>
              <td>${at.processo || 'N/A'}</td>
              <td>${at.ticket ? `<a href="${at.ticket}" target="_blank">Abrir</a>` : 'N/A'}</td>
              <td><button class="btn-delete" onclick="excluirAtendimento(${at.id})">Excluir</button></td>
            </tr>
          `).join('')
          : '<tr><td colspan="6" style="text-align:center;">Nenhum atendimento encontrado</td></tr>';

        document.getElementById('totalMes').textContent = dados.length;
        document.getElementById('totalInstalacoes').textContent = dados.filter(a => a.processo === 'Instala√ß√£o de Sistema').length;
        document.getElementById('totalReinstalacoes').textContent = dados.filter(a => a.processo === 'Reinstala√ß√£o Servidor').length;
      } catch (error) {
        console.error(error);
        alert('Erro ao carregar atendimentos.');
      }
    }

    async function excluirAtendimento(id) {
      if (!confirm('Deseja excluir este atendimento?')) return;
      try {
        const res = await fetch(`/api/atendimentos/${id}`, { method: 'DELETE' });
        if (!res.ok) throw new Error();
        alert('‚úÖ Atendimento exclu√≠do!');
        buscarAtendimentos();
      } catch {
        alert('‚ùå Erro ao excluir atendimento.');
      }
    }

    async function preencherFiltroAgente() {
      const res = await fetch('/api/agentes');
      const dados = await res.json();
      const select = document.getElementById('filtroAgente');
      dados.forEach(a => {
        const opt = document.createElement('option');
        opt.value = a.id;
        opt.textContent = a.nome;
        select.appendChild(opt);
      });
    }

    async function preencherFiltroProcesso() {
      const res = await fetch('/api/processos');
      const dados = await res.json();
      const select = document.getElementById('filtroProcesso');
      dados.forEach(p => {
        const opt = document.createElement('option');
        opt.value = p.id;
        opt.textContent = p.nome;
        select.appendChild(opt);
      });
    }

    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('temaPreferido', theme);
      document.querySelector('.theme-toggle').textContent = theme === 'dark' ? 'üåû' : 'üåô';
    }

    function toggleTheme() {
      const atual = document.documentElement.getAttribute('data-theme') || 'light';
      const novo = atual === 'dark' ? 'light' : 'dark';
      setTheme(novo);
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const tema = localStorage.getItem('temaPreferido') || 'light';
      setTheme(tema);
      await preencherFiltroAgente();
      await preencherFiltroProcesso();
      buscarAtendimentos();
    });
  </script>
</body>
</html>

