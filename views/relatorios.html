<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Relat√≥rios de Atendimentos</title>
  <link rel="icon" type="image/x-icon" href="/img/favicon.ico" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-color: #f8f9fa;
      --text-color: #343a40;
      --card-bg: #fff;
      --header-color: #2C3E50;
      --border-color: #ccc;
      --hover-color: #f1f1f1;
      --thead-bg: linear-gradient(90deg, #4CAF50, #45a049);
      --primary: #4CAF50;
      --primary-hover: #45a049;
      --blue: #007bff;
      --blue-hover: #0056b3;
    }

    [data-theme="dark"] {
      --bg-color: #1e1e1e;
      --text-color: #e0e0e0;
      --card-bg: #2c2c2c;
      --header-color: #f5f5f5;
      --border-color: #444;
      --hover-color: #2a2a2a;
      --thead-bg: linear-gradient(90deg, #2ecc71, #27ae60);
      --primary: #2ecc71;
      --primary-hover: #27ae60;
      --blue: #3498db;
      --blue-hover: #2980b9;
    }

    body {
      font-family: 'Arial', sans-serif;
      margin: 20px;
      background: var(--bg-color);
      color: var(--text-color);
      transition: background 0.3s, color 0.3s;
    }

    h2 {
      text-align: center;
      color: var(--header-color);
      margin-bottom: 10px;
    }

    .theme-toggle {
      position: fixed;
      top: 15px;
      right: 15px;
      background-color: var(--blue);
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 50px;
      font-size: 0.9rem;
      cursor: pointer;
      z-index: 999;
    }

    .theme-toggle:hover { background-color: var(--blue-hover); }

    .btn-voltar {
      position: fixed;
      top: 15px;
      left: 15px;
      padding: 8px 14px;
      background: var(--blue);
      color: white;
      border-radius: 6px;
      text-decoration: none;
      z-index: 998;
      font-weight: bold;
    }

    .btn-voltar:hover {
      background-color: var(--blue-hover);
    }

    .filtros, .nav-relatorios {
      text-align: center;
      margin-bottom: 20px;
    }

    .filtros input, .filtros select, .filtros button, .nav-relatorios button {
      margin: 0 8px;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid var(--border-color);
      background-color: var(--card-bg);
      color: var(--text-color);
      font-weight: bold;
    }

    button {
      background-color: var(--primary);
      color: white;
      cursor: pointer;
    }

    button:hover { background-color: var(--primary-hover); }

    .chart-container, .table-container {
      max-width: 800px;
      margin: 20px auto;
      background: var(--card-bg);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
    }

    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px 15px; border-bottom: 1px solid var(--border-color); text-align: left; }
    thead { background: var(--thead-bg); color: white; }
    tbody tr:hover { background-color: var(--hover-color); }

    .relatorio-section { display: none; }
    .relatorio-section.ativo { display: block; }
  </style>
</head>
<body>
  <!-- Bot√£o Voltar ao Topo -->
  <a href="/homepage" class="btn-voltar">‚¨Ö Voltar</a>

  <!-- Bot√£o de alternar tema -->
  <button class="theme-toggle" onclick="toggleTheme()">üåô</button>

  <h2>Relat√≥rios de Atendimentos</h2>

  <!-- Filtros -->
  <div class="filtros">
    <label for="filtroMes">M√™s:</label>
    <input type="month" id="filtroMes" />

    <label for="filtroBackup">Backup Cloud:</label>
    <select id="filtroBackup">
      <option value="">Todos</option>
      <option value="Sim">Com Backup Cloud</option>
      <option value="N√£o">Sem Backup Cloud</option>
    </select>

    <label for="tipoGrafico">Tipo de Gr√°fico:</label>
    <select id="tipoGrafico">
      <option value="bar">Barra</option>
      <option value="pie">Pizza</option>
      <option value="doughnut">Doughnut</option>
    </select>

    <button onclick="carregarRelatorio()">üîç Buscar</button>
  </div>

  <!-- Navega√ß√£o entre relat√≥rios -->
  <div class="nav-relatorios">
    <button onclick="mostrarSecao('processos')">üîÅ Por Processo</button>
    <button onclick="mostrarSecao('sistemas')">üíª Por Sistema</button>
    <button onclick="mostrarSecao('agentes')">üë• Por Agente</button>
    <button onclick="mostrarSecao('comparativo')">üìä Comparativo</button>
  </div>

  <!-- Se√ß√µes -->
  <div id="secao-processos" class="relatorio-section ativo">
    <div class="chart-container"><canvas id="graficoProcessos"></canvas></div>
    <div class="table-container">
      <table>
        <thead><tr><th>Processo</th><th>Quantidade</th></tr></thead>
        <tbody id="tabelaProcessos"></tbody>
      </table>
    </div>
  </div>

  <div id="secao-sistemas" class="relatorio-section">
    <div class="chart-container"><canvas id="graficoSistemas"></canvas></div>
  </div>

  <div id="secao-agentes" class="relatorio-section">
    <div class="table-container">
      <table>
        <thead><tr><th>Agente</th><th>Total</th></tr></thead>
        <tbody id="tabelaAgentes"></tbody>
      </table>
    </div>
  </div>

  <div id="secao-comparativo" class="relatorio-section">
    <div class="chart-container"><canvas id="graficoComparativoProcessos"></canvas></div>
    <div class="chart-container"><canvas id="graficoComparativoSistemas"></canvas></div>
  </div>
<script>
  let graficoProcessos, graficoSistemas, graficoComparativoProcessos, graficoComparativoSistemas;

  function setTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('temaPreferido', theme);
    document.querySelector('.theme-toggle').textContent = theme === 'dark' ? 'üåû' : 'üåô';
  }

  function toggleTheme() {
    const atual = document.documentElement.getAttribute('data-theme') || 'light';
    const novo = atual === 'dark' ? 'light' : 'dark';
    setTheme(novo);
  }

  function mostrarSecao(secao) {
    document.querySelectorAll('.relatorio-section').forEach(div => div.classList.remove('ativo'));
    document.getElementById(`secao-${secao}`).classList.add('ativo');
  }

  function getFiltroParams() {
    const mesSelecionado = document.getElementById('filtroMes').value || new Date().toISOString().slice(0, 7);
    const [ano, mes] = mesSelecionado.split('-');
    const backupCloud = document.getElementById('filtroBackup').value;
    return { mes, ano, backupCloud };
  }

  async function carregarRelatorio() {
    const { mes, ano, backupCloud } = getFiltroParams();
    const tipo = document.getElementById('tipoGrafico').value;

    await carregarProcessos(mes, ano, backupCloud, tipo);
    await carregarSistemas(mes, ano, tipo);
    await carregarAgentes(mes, ano, backupCloud);
    await carregarComparativo(mes, ano);
  }

  async function carregarProcessos(mes, ano, backupCloud, tipo) {
    let url = `/api/relatorios?mes=${mes}&ano=${ano}`;
    if (backupCloud) url += `&backup_cloud=${backupCloud}`;
    const res = await fetch(url);
    const dados = await res.json();

    const labels = dados.map(d => d.processo);
    const valores = dados.map(d => d.total);
    const tabela = document.getElementById('tabelaProcessos');
    tabela.innerHTML = dados.map(d => `<tr><td>${d.processo}</td><td>${d.total}</td></tr>`).join('');

    if (graficoProcessos) graficoProcessos.destroy();
    graficoProcessos = new Chart(document.getElementById('graficoProcessos'), {
      type: tipo,
      data: {
        labels,
        datasets: [{ label: 'Processos', data: valores, backgroundColor: '#4CAF50' }]
      },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
  }

  async function carregarSistemas(mes, ano, tipo) {
    const res = await fetch(`/api/relatorios/sistemas?mes=${mes}&ano=${ano}`);
    const dados = await res.json();

    const labels = dados.map(d => d.sistema);
    const valores = dados.map(d => d.instalacoes);

    if (graficoSistemas) graficoSistemas.destroy();
    graficoSistemas = new Chart(document.getElementById('graficoSistemas'), {
      type: tipo,
      data: {
        labels,
        datasets: [{ label: 'Instala√ß√µes', data: valores, backgroundColor: '#007bff' }]
      },
      options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
    });
  }

  async function carregarAgentes(mes, ano, backupCloud) {
    let url = `/api/relatorios/agentes?mes=${mes}&ano=${ano}`;
    if (backupCloud) url += `&backup_cloud=${backupCloud}`;
    const res = await fetch(url);
    const dados = await res.json();

    const tbody = document.getElementById('tabelaAgentes');
    tbody.innerHTML = dados.map(d => `<tr><td>${d.agente}</td><td>${d.total}</td></tr>`).join('');
  }

  async function carregarComparativo(mes, ano) {
  const res = await fetch(`/api/relatorios/comparativo-processos?mes=${mes}&ano=${ano}`);
  const dados = await res.json();
  const processos = dados.processos;

  const labels = processos.map(p => p.processo);
  const atual = processos.map(p => p.total_atual);
  const anterior = processos.map(p => p.total_anterior);

  // Tabela com tend√™ncia (atualiza a tabela de processos, se desejar)
  const tabela = document.getElementById('tabelaProcessos');
  if (tabela) {
    tabela.innerHTML = processos.map(p => {
      const icone = p.total_atual > p.total_anterior
        ? 'üîº'
        : p.total_atual < p.total_anterior
        ? 'üîΩ'
        : '‚ûñ';
      return `<tr><td>${p.processo}</td><td>${p.total_atual} ${icone}</td></tr>`;
    }).join('');
  }

  if (graficoComparativoProcessos) graficoComparativoProcessos.destroy();
  graficoComparativoProcessos = new Chart(document.getElementById('graficoComparativoProcessos'), {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'M√™s Atual', data: atual, backgroundColor: '#4CAF50' },
        { label: 'M√™s Anterior', data: anterior, backgroundColor: '#FF5733' }
      ]
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
  });

  // Carregar comparativo de sistemas
  const sistemasRes = await fetch(`/api/relatorios/sistemas-comparativo?mes=${mes}&ano=${ano}`);
  const sist = await sistemasRes.json();
  const labelsS = sist.map(s => s.sistema);
  const atualS = sist.map(s => s.instalacoes_atual);
  const anteriorS = sist.map(s => s.instalacoes_anterior);

  if (graficoComparativoSistemas) graficoComparativoSistemas.destroy();
  graficoComparativoSistemas = new Chart(document.getElementById('graficoComparativoSistemas'), {
    type: 'bar',
    data: {
      labels: labelsS,
      datasets: [
        { label: 'M√™s Atual', data: atualS, backgroundColor: '#007bff' },
        { label: 'M√™s Anterior', data: anteriorS, backgroundColor: '#ffc107' }
      ]
    },
    options: { responsive: true, plugins: { legend: { position: 'bottom' } } }
  });
}

  document.addEventListener('DOMContentLoaded', () => {
    const tema = localStorage.getItem('temaPreferido') || 'light';
    setTheme(tema);
    carregarRelatorio();
  });
</script>
</body>
</html>
